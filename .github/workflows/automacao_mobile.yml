name: Mobile Automation CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  android-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: üîÑ Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üì¶ Instalar depend√™ncias do sistema
        run: |
          sudo apt update
          sudo apt install -y openjdk-11-jdk nodejs npm wget unzip netcat-openbsd

      - name: üêç Instalar depend√™ncias Python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üì≤ Instalar SDK Android e configurar AVD
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: default
          arch: x86_64
          profile: pixel
          script: echo "‚úÖ Emulador pronto!"

      - name: üöÄ Iniciar Appium Server
        run: |
          npm install -g appium
          nohup appium --log-level error > appium.log 2>&1 &

      - name: ‚è≥ Aguardar Appium iniciar
        run: |
          for i in {1..10}; do
            if nc -z localhost 4723; then
              echo "‚úÖ Appium est√° rodando!"
              break
            else
              echo "‚è≥ Aguardando Appium iniciar..."
              sleep 3
            fi
          done

          nc -z localhost 4723 || (echo "‚ùå Appium n√£o iniciou." && exit 1)

      - name: üéØ Executar testes Robot Framework
        run: |
          robot --outputdir results test_cases/

      - name: üì§ Upload dos relat√≥rios
        uses: actions/upload-artifact@v4
        with:
          name: robot-results
          path: results/
