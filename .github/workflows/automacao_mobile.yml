name: Testes Mobile com BrowserStack

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: üêç Configurar ambiente Python
        run: |
          python -m pip install --upgrade pip
          pip install robotframework robotframework-appiumlibrary Appium-Python-Client==2.7.1

      - name: üì± Enviar APK para o BrowserStack
        id: upload_apk
        run: |
          RESPONSE=$(curl -u "${{ secrets.BROWSERSTACK_USERNAME }}:${{ secrets.BROWSERSTACK_ACCESS_KEY }}" \
            -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
            -F "file=@apps/app.apk")
          echo "apk_url=$(echo $RESPONSE | jq -r .app_url)" >> $GITHUB_ENV

      - name: ‚ñ∂Ô∏è Rodar testes Robot Framework
        env:
          REMOTE_URL: http://hub-cloud.browserstack.com/wd/hub
          PLATFORM_NAME: Android
          DEVICE_NAME: Google Pixel 6
          PLATFORM_VERSION: 12.0
          APP: ${{ env.apk_url }}
          APP_PACKAGE: br.gov.mt.cepromat.mtcidadao
          APP_ACTIVITY: br.gov.mt.cepromat.mtcidadao.MainActivity
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
        run: |
          robot test_cases/

      - name: üìÇ Upload dos resultados
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: resultados
          path: |
            output.xml
            report.html
            log.html
