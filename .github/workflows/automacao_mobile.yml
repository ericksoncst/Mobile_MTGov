name: Testes Mobile com BrowserStack

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: üì• Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: üêç Configurar ambiente Python
        run: |
          python -m pip install --upgrade pip
          pip install robotframework robotframework-appiumlibrary Appium-Python-Client==2.7.1 jq

      - name: üì± Enviar APK para o BrowserStack
        id: upload_apk
        run: |
          RESPONSE=$(curl -u "${{ secrets.BROWSERSTACK_USERNAME }}:${{ secrets.BROWSERSTACK_ACCESS_KEY }}" \
            -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
            -F "file=@apps/app.apk")
          echo "apk_url=$(echo $RESPONSE | jq -r .app_url)" >> $GITHUB_OUTPUT
          echo "APP_URL=$(echo $RESPONSE | jq -r .app_url)" >> $GITHUB_ENV

      - name: ‚è≥ Aguardar processamento do APK
        run: |
          sleep 30  # Wait for APK to be fully processed on BrowserStack

      - name: ‚ñ∂Ô∏è Rodar testes Robot Framework
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          REMOTE_URL: "http://${{ secrets.BROWSERSTACK_USERNAME }}:${{ secrets.BROWSERSTACK_ACCESS_KEY }}@hub-cloud.browserstack.com/wd/hub"
          PLATFORM_NAME: Android
          DEVICE_NAME: "Google Pixel 6"
          OS_VERSION: 12.0
          APP: ${{ env.APP_URL }}
          APP_PACKAGE: br.gov.mt.cepromat.mtcidadao
          APP_ACTIVITY: br.gov.mt.cepromat.mtcidadao.MainActivity
          BROWSERSTACK_DEBUG: true
          BROWSERSTACK_VIDEO: true
          BROWSERSTACK_NETWORK_LOGS: true
        run: |
          echo "Verificando vari√°veis de ambiente:"
          echo "APP_URL: $APP"
          echo "APP_PACKAGE: $APP_PACKAGE"
          echo "APP_ACTIVITY: $APP_ACTIVITY"
          
          robot --outputdir results \
            --variable REMOTE_URL:"$REMOTE_URL" \
            --variable PLATFORM_NAME:"$PLATFORM_NAME" \
            --variable DEVICE_NAME:"$DEVICE_NAME" \
            --variable PLATFORM_VERSION:"$OS_VERSION" \
            --variable APP:"$APP" \
            --variable APP_PACKAGE:"$APP_PACKAGE" \
            --variable APP_ACTIVITY:"$APP_ACTIVITY" \
            --variable BROWSERSTACK_USERNAME:"$BROWSERSTACK_USERNAME" \
            --variable BROWSERSTACK_ACCESS_KEY:"$BROWSERSTACK_ACCESS_KEY" \
            test_cases/

      - name: üìÇ Upload dos resultados
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: resultados
          path: |
            results/output.xml
            results/report.html
            results/log.html